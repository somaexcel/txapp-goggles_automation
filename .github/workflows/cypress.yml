name: Cypress CI + Slack

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    env:
      TEST_ENV: production

    steps:
      # 1️⃣ Checkout
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Node setup
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3️⃣ Install deps
      - name: Install dependencies
        run: npm ci

      # 4️⃣ Run Cypress (single spec)
      - name: Run Cypress tests
        run: npx cypress run --spec "cypress/e2e/taxapp.cy.js"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 5️⃣ Extract results safely
      - name: Extract Test Results
        run: |
          JSON_FILE=$(ls cypress/reports/.jsons/*.json 2>/dev/null | head -1)

          if [ -f "$JSON_FILE" ]; then
            PASSED=$(jq '.stats.passes' "$JSON_FILE")
            FAILED=$(jq '.stats.failures' "$JSON_FILE")
          else
            PASSED=0
            FAILED=0
          fi

          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV

      # 6️⃣ Generate mochawesome HTML
      - name: Generate Mochawesome report
        run: |
          if ls cypress/reports/.jsons/*.json 1> /dev/null 2>&1; then
            npx mochawesome-merge cypress/reports/.jsons/*.json > cypress/reports/report.json
            npx marge cypress/reports/report.json --reportDir cypress/reports
          else
            echo "No mochawesome JSON files found — skipping merge"
          fi

      # 7️⃣ Upload artifact
      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: mochawesome-report
          path: cypress/reports

      # 8️⃣ Slack notification
      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not set — skipping"
            exit 0
          fi

          if [ "${{ job.status }}" == "success" ]; then
            STATUS="✅ PASSED"
            COLOR="good"
          else
            STATUS="❌ FAILED"
            COLOR="danger"
          fi

          REPORT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"$COLOR\",
              \"title\": \"Cypress Test Run: $STATUS\",
              \"fields\": [
                {\"title\": \"Environment\", \"value\": \"$TEST_ENV\", \"short\": true},
                {\"title\": \"Passed\", \"value\": \"${{ env.PASSED }}\", \"short\": true},
                {\"title\": \"Failed\", \"value\": \"${{ env.FAILED }}\", \"short\": true},
                {\"title\": \"Report\", \"value\": \"$REPORT_URL\"}
              ]
            }]
          }" \
          "$SLACK_WEBHOOK"