name: Cypress CI + Slack

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests
        run: npx cypress run --spec "cypress/e2e/taxapp.cy.js"

      - name: Extract Test Results
        run: |
          JSON_FILE=$(ls cypress/reports/.jsons/*.json 2>/dev/null | head -1)

          if [ -f "$JSON_FILE" ]; then
            PASSED=$(grep -o '"passes":[0-9]*' "$JSON_FILE" | head -1 | grep -o '[0-9]*')
            FAILED=$(grep -o '"failures":[0-9]*' "$JSON_FILE" | head -1 | grep -o '[0-9]*')
          else
            PASSED=0
            FAILED=0
          fi

          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV 
        
      - name: Generate Mochawesome report
          run: |
            npx mochawesome-merge cypress/reports/.jsons/*.json > cypress/reports/report.json
            npx marge cypress/reports/report.json --reportDir cypress/reports

      # Step: Send Slack notification
      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not set — skipping"
            exit 0
          fi

          if [ "${{ job.status }}" == "success" ]; then
            STATUS="✅ PASSED"
            COLOR="good"
          else
            STATUS="❌ FAILED"
            COLOR="danger"
          fi

          REPORT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"$COLOR\",
              \"title\": \"Cypress Test Run: $STATUS\",
              \"fields\": [
                {\"title\": \"Passed\", \"value\": \"${{ env.PASSED }}\", \"short\": true},
                {\"title\": \"Failed\", \"value\": \"${{ env.FAILED }}\", \"short\": true},
                {\"title\": \"Report\", \"value\": \"$REPORT_URL\"}
              ]
            }]
          }" \
          "$SLACK_WEBHOOK"   