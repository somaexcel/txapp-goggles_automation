name: Cypress CI + Slack

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests
        run: npx cypress run --spec "cypress/e2e/taxapp.cy.js"

      - name: Debug report files
        run: |
          echo "===== REPORT TREE ====="
          pwd
          ls -la
          ls -la cypress
          ls -la cypress/reports
          ls -R cypress/reports || true
          
      - name: Upload Mochawesome report
        uses: actions/upload-artifact@v4
        with:
          name: mochawesome-report
          path: cypress/reports/
      
      - name: Extract test summary
        if: always()
        run: |
          PASSED=$(grep -o '"passes":[0-9]*' cypress/reports/.jsons/*.json | head -1 | grep -o '[0-9]*')
          FAILED=$(grep -o '"failures":[0-9]*' cypress/reports/.jsons/*.json | head -1 | grep -o '[0-9]*')
          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV

      # Step: Send Slack notification
      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="✅ PASSED"
            COLOR="good"
          else
            STATUS="❌ FAILED"
            COLOR="danger"
          fi

          REPORT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"$COLOR\",
              \"title\": \"Cypress Test Run: $STATUS\",
              \"fields\": [
                {\"title\": \"Passed\", \"value\": \"${{ env.PASSED }}\", \"short\": true},
                {\"title\": \"Failed\", \"value\": \"${{ env.FAILED }}\", \"short\": true}
              ]
            }]
          }" \
          $SLACK_WEBHOOK    